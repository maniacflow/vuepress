<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>环信即时通讯 IM Android 快速开始 | 环信 IM 文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepress/logo.png">
    <meta name="description" content="环信即时通讯云最新集成文档，一天内即可帮APP快速集成聊天功能。 环信客户互动云集成文档，快速多渠道集成，为企业提供智能客服系统。">
    
    <link rel="preload" href="/vuepress/assets/css/0.styles.7ff8f1d4.css" as="style"><link rel="preload" href="/vuepress/assets/js/app.3775eb30.js" as="script"><link rel="preload" href="/vuepress/assets/js/3.db456b6c.js" as="script"><link rel="preload" href="/vuepress/assets/js/1.7ac2d96d.js" as="script"><link rel="preload" href="/vuepress/assets/js/27.5accaed6.js" as="script"><link rel="prefetch" href="/vuepress/assets/js/10.e8437e28.js"><link rel="prefetch" href="/vuepress/assets/js/11.9fe3bf56.js"><link rel="prefetch" href="/vuepress/assets/js/12.5bdc7cb4.js"><link rel="prefetch" href="/vuepress/assets/js/13.fd9a688c.js"><link rel="prefetch" href="/vuepress/assets/js/14.c5d1ee43.js"><link rel="prefetch" href="/vuepress/assets/js/15.6249d44e.js"><link rel="prefetch" href="/vuepress/assets/js/16.e2333c54.js"><link rel="prefetch" href="/vuepress/assets/js/17.a016e123.js"><link rel="prefetch" href="/vuepress/assets/js/18.a4e71e3e.js"><link rel="prefetch" href="/vuepress/assets/js/19.c2a72fc0.js"><link rel="prefetch" href="/vuepress/assets/js/20.5ef4c978.js"><link rel="prefetch" href="/vuepress/assets/js/21.f02692d3.js"><link rel="prefetch" href="/vuepress/assets/js/22.6674015c.js"><link rel="prefetch" href="/vuepress/assets/js/23.7270cb71.js"><link rel="prefetch" href="/vuepress/assets/js/24.24b1ec9d.js"><link rel="prefetch" href="/vuepress/assets/js/25.d5729017.js"><link rel="prefetch" href="/vuepress/assets/js/26.48b974ea.js"><link rel="prefetch" href="/vuepress/assets/js/28.0263440e.js"><link rel="prefetch" href="/vuepress/assets/js/29.598a97cf.js"><link rel="prefetch" href="/vuepress/assets/js/30.c348f978.js"><link rel="prefetch" href="/vuepress/assets/js/31.e8ccf099.js"><link rel="prefetch" href="/vuepress/assets/js/32.0e645f12.js"><link rel="prefetch" href="/vuepress/assets/js/33.24a50465.js"><link rel="prefetch" href="/vuepress/assets/js/34.ff18a349.js"><link rel="prefetch" href="/vuepress/assets/js/35.4e68b9ba.js"><link rel="prefetch" href="/vuepress/assets/js/36.efabe680.js"><link rel="prefetch" href="/vuepress/assets/js/37.662d4795.js"><link rel="prefetch" href="/vuepress/assets/js/38.126de51e.js"><link rel="prefetch" href="/vuepress/assets/js/39.95565ede.js"><link rel="prefetch" href="/vuepress/assets/js/4.e2bccb64.js"><link rel="prefetch" href="/vuepress/assets/js/40.6de23b15.js"><link rel="prefetch" href="/vuepress/assets/js/41.6d31188a.js"><link rel="prefetch" href="/vuepress/assets/js/42.f3454cae.js"><link rel="prefetch" href="/vuepress/assets/js/43.785e27a0.js"><link rel="prefetch" href="/vuepress/assets/js/44.2732245f.js"><link rel="prefetch" href="/vuepress/assets/js/45.aa9d062b.js"><link rel="prefetch" href="/vuepress/assets/js/46.f1767cea.js"><link rel="prefetch" href="/vuepress/assets/js/47.6ea90c89.js"><link rel="prefetch" href="/vuepress/assets/js/48.56a5e7e6.js"><link rel="prefetch" href="/vuepress/assets/js/49.8203ac0c.js"><link rel="prefetch" href="/vuepress/assets/js/5.05775f0d.js"><link rel="prefetch" href="/vuepress/assets/js/50.30fd124a.js"><link rel="prefetch" href="/vuepress/assets/js/51.6e8fe59e.js"><link rel="prefetch" href="/vuepress/assets/js/52.3d80ae80.js"><link rel="prefetch" href="/vuepress/assets/js/53.71b8512d.js"><link rel="prefetch" href="/vuepress/assets/js/6.7df3bdd1.js"><link rel="prefetch" href="/vuepress/assets/js/7.0be7f205.js"><link rel="prefetch" href="/vuepress/assets/js/8.5daa8986.js"><link rel="prefetch" href="/vuepress/assets/js/9.08e122ea.js">
    <link rel="stylesheet" href="/vuepress/assets/css/0.styles.7ff8f1d4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div><div class="header-container"><div class="logo"><a href="/vuepress/" class="router-link-active"><span><img src="/vuepress/logo.png"></span> <h1>环信 IM 文档</h1></a></div> <div class="nav pc-nav"><div class="main-nav"><a href="/vuepress/product/introduction.html">产品简介</a><a href="/vuepress/document/Android/quickstart" class="active">集成文档</a><a href="/vuepress/api/Android">API 参考</a></div> <div class="nav-extra"><div class="search-container"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="secondary-nav"><a href="https://console.easemob.com/ticket" target="_blank">提交工单</a></div> <div class="switch-lang"><a href="javascript:;">选择语言<span class="triangle"></span></a> <div id="sub-menu" class="sub-menu menu-hidden"><ul><li class="active"><a href="/vuepress/document/Android/quickstart.html" aria-current="page" class="router-link-exact-active router-link-active">简体中文</a></li><li><a href="/vuepress/en/document/Android/quickstart.html">English</a></li></ul></div></div> <div class="login-register"><a href="https://console.easemob.com/user/login" target="_blank">登录</a><a href="https://console.easemob.com/user/register" target="_blank">注册</a></div></div></div> <div class="mobile-nav"><img src="/vuepress/icon-menu.png"></div></div> <!----> <!----></div> <div class="content-container"><div class="sider-container"><div class="platform"><div class="platform-input"><div class="platform-text"><img src="/vuepress/icon-Android-hover.svg" alt> <span>Android</span></div> <div class="select-icon"><i class="icon-arrow"></i></div></div> <div id="platform-list" class="platform-list menu-hidden"><!----><div class="group"><div class="group-title">平台</div> <div class="options"><div data-key="Android" class="option-item"><img src="/vuepress/icon-Android.svg" alt class="default"> <img src="/vuepress/icon-Android-hover.svg" alt class="active"> <span>Android</span></div><div data-key="iOS" class="option-item"><img src="/vuepress/icon-iOS.svg" alt class="default"> <img src="/vuepress/icon-iOS-hover.svg" alt class="active"> <span>iOS</span></div><div data-key="Web" class="option-item"><img src="/vuepress/icon-web.svg" alt class="default"> <img src="/vuepress/icon-web-hover.png" alt class="active"> <span>Web</span></div><div data-key="Windows" class="option-item"><img src="/vuepress/icon-windows.svg" alt class="default"> <img src="/vuepress/icon-windows-hover.svg" alt class="active"> <span>Windows</span></div></div></div><div class="group"><div class="group-title">框架</div> <div class="options"><div data-key="Mini-program" class="option-item"><img src="/vuepress/icon-mini-program.svg" alt class="default"> <img src="/vuepress/icon-mini-program-hover.svg" alt class="active"> <span>小程序</span></div><div data-key="Flutter" class="option-item"><img src="/vuepress/icon-flutter.svg" alt class="default"> <img src="/vuepress/icon-flutter-hover.png" alt class="active"> <span>Flutter</span></div><div data-key="React-Native" class="option-item"><img src="/vuepress/icon-ReactNative.svg" alt class="default"> <img src="/vuepress/icon-ReactNative-hover.svg" alt class="active"> <span>React Native</span></div></div></div><div class="group"><div class="group-title"></div> <div class="options"><div data-key="Server-side" class="option-item"><img src="/vuepress/icon-server-dark.png" alt class="default"> <img src="/vuepress/icon-server-light.png" alt class="active"> <span>服务端</span></div></div></div></div></div> <div class="sider-menu"><div class="item"><h2>快速开始</h2> <ul><li><a href="/vuepress/document/Android/demo_android.html">Demo（EaseIM App）</a></li><li class="active"><a href="/vuepress/document/Android/quick_start_android.html">快速开始（不使用 EaseIMKIT）</a></li></ul></div><div class="item"><h2>基础功能</h2> <ul><li><div><a href="javascript:;">消息管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/message_overview_android.html">消息概述</a></li><li><a href="/vuepress/document/Android/message_send_receive_android.html">发送和接收消息</a></li><li><a href="/vuepress/document/Android/message_manage_android.html">管理本地消息数据</a></li><li><a href="/vuepress/document/Android/message_retrieve_android.html">从服务器获取消息（消息漫游）</a></li><li><a href="/vuepress/document/Android/message_receipt_android.html">管理消息回执</a></li><li><a href="/vuepress/document/Android/message_translation_android.html">翻译</a></li></ul></div></li><li><a href="/vuepress/document/Android/userprofile_android.html">管理用户属性</a></li><li><a href="/vuepress/document/Android/user_relationship_android.html">管理用户关系</a></li><li><div><a href="javascript:;">群组管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/group_overview_android.html">群组概述</a></li><li><a href="/vuepress/document/Android/group_manage_android.html">管理群组</a></li><li><a href="/vuepress/document/Android/group_members_android.html">管理群组成员</a></li><li><a href="/vuepress/document/Android/group_attributes_android.html">管理群组属性</a></li></ul></div></li><li><div><a href="javascript:;">聊天室管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/room_overview_android.html">聊天室概述</a></li><li><a href="/vuepress/document/Android/room_manage_android.html">创建和管理聊天室</a></li><li><a href="/vuepress/document/Android/room_members_android.html">管理聊天室成员</a></li><li><a href="/vuepress/document/Android/room_attributes_android.html">管理聊天室属性</a></li></ul></div></li></ul></div><div class="item"><h2>进阶功能</h2> <ul><li><a href="/vuepress/document/Android/multi_device_android.html">登录多个设备</a></li><li><a href="/vuepress/document/Android/presence_android.html">管理在线状态订阅</a></li><li><a href="/vuepress/document/Android/reaction_android.html">消息表情回复</a></li><li><div><a href="javascript:;">子区管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/thread_android.html">管理子区</a></li><li><a href="/vuepress/document/Android/thread_message_android.html">管理子区消息</a></li></ul></div></li><li><a href="/vuepress/document/Android/moderation_report_android.html">消息审核</a></li></ul></div><div class="item"><h2>其他</h2> <ul><li><a href="/vuepress/document/Android/error_android.html">错误码</a></li></ul></div></div></div> <div data-key="v-52f617dd" class="description-container"><div><div class="content__default"><h1 id="环信即时通讯-im-android-快速开始"><a href="#环信即时通讯-im-android-快速开始" class="header-anchor">#</a> 环信即时通讯 IM Android 快速开始</h1> <p></p><div class="table-of-contents"><ul><li><a href="#实现原理">实现原理</a></li><li><a href="#前提条件">前提条件</a></li><li><a href="#准备开发环境">准备开发环境</a><ul><li><a href="#_1-创建-android-项目">1. 创建 Android 项目</a></li><li><a href="#_2-集成-sdk">2. 集成 SDK</a></li><li><a href="#_3-添加项目权限">3. 添加项目权限</a></li><li><a href="#_4-防止代码混淆">4. 防止代码混淆</a></li></ul></li><li><a href="#实现单聊">实现单聊</a><ul><li><a href="#_1-sdk-初始化">1. SDK 初始化</a></li><li><a href="#_2-创建账号">2. 创建账号</a></li><li><a href="#_3-登录账号">3. 登录账号</a></li><li><a href="#_4-发送一条单聊消息">4. 发送一条单聊消息</a></li></ul></li><li><a href="#参考信息">参考信息</a><ul><li><a href="#android-sdk-介绍">Android SDK 介绍</a></li><li><a href="#sdk-目录讲解">SDK 目录讲解</a></li><li><a href="#第三方库介绍">第三方库介绍</a></li><li><a href="#sdk-中相关异步-同步处理方法介绍">SDK 中相关异步/同步处理方法介绍</a></li><li><a href="#取本地-log">取本地 log</a></li><li><a href="#自动登录">自动登录</a></li><li><a href="#退出登录">退出登录</a></li><li><a href="#用户被封禁后的提示">用户被封禁后的提示</a></li><li><a href="#注册连接状态监听">注册连接状态监听</a></li></ul></li></ul></div><p></p> <p>本文介绍如何快速集成环信即时通讯 IM Android SDK 实现单聊。</p> <p><strong>最近遇到因 app 隐私问题下架的开发者需注意：</strong></p> <ul><li>请在点击获取隐私权限以后启动环信 SDK 初始化。</li> <li><code>EMChatService</code> 和 <code>EMJobService</code> 为早期 SDK 内在应用退到后台后，对应用进行保活的程序，可以不进行注册；<code>EMMonitorReceiver</code> 为监听开机自启动服务，也可以不注册。</li></ul> <h2 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h2> <p>下图展示在客户端发送和接收一对一文本消息的工作流程。</p> <p><img src="https://docs-im.easemob.com/_media/ccim/web/sendandreceivemsg.png?w=1000&amp;tok=312a4a" alt="img"></p> <h2 id="前提条件"><a href="#前提条件" class="header-anchor">#</a> 前提条件</h2> <ul><li>Android Studio 3.0 或以上版本；</li> <li>Android SDK API 等级 19 或以上；</li> <li>Android 4.4 或以上版本的设备；</li> <li>有效的环信即时通讯 IM 开发者账号和 App key，见 <a href="https://console.easemob.com/user/login" target="_blank" rel="noopener noreferrer">环信即时通讯云控制台<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <h2 id="准备开发环境"><a href="#准备开发环境" class="header-anchor">#</a> 准备开发环境</h2> <p>本节介绍如何创建项目，将环信即时通讯 IM Android SDK 集成到你的项目中，并添加相应的设备权限。</p> <h3 id="_1-创建-android-项目"><a href="#_1-创建-android-项目" class="header-anchor">#</a> 1. 创建 Android 项目</h3> <p>参考以下步骤创建一个 Android 项目。</p> <ol><li>打开 Android Studio，点击 <strong>Start a new Android Studio project</strong>。</li> <li>在 <strong>Select a Project Template</strong> 界面，选择 <strong>Phone and Tablet &gt; Empty Activity</strong>，然后点击 <strong>Next</strong>。</li> <li>在 <strong>Configure Your Project</strong> 界面，依次填入以下内容：
<ul><li><strong>Name</strong>：你的 Android 项目名称，如 HelloWorld。</li> <li><strong>Package name</strong>：你的项目包的名称，如 com.hyphenate.helloworld。</li> <li><strong>Save location</strong>：项目的存储路径。</li> <li><strong>Language</strong>：项目的编程语言，如 Java。</li> <li><strong>Minimum API level</strong>：项目的最低 API 等级。</li></ul></li></ol> <p>然后点击 <strong>Finish</strong>。根据屏幕提示，安装所需插件。</p> <p>上述步骤使用 <strong>Android Studio 3.6.2</strong> 示例。你也可以直接参考 Android Studio 官网文档<a href="https://developer.android.com/training/basics/firstapp" target="_blank" rel="noopener noreferrer">创建首个应用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="_2-集成-sdk"><a href="#_2-集成-sdk" class="header-anchor">#</a> 2. 集成 SDK</h3> <p>选择如下任意一种方式将环信即时通讯 IM SDK 集成到你的项目中。</p> <p><strong>注意</strong></p> <ul><li>以下集成方式只需选择一种，同时使用多种集成方式可能会报错。</li> <li>请点击查看发版说明获得最新版本号。</li></ul> <h4 id="方法一-使用-mavencentral-自动集成"><a href="#方法一-使用-mavencentral-自动集成" class="header-anchor">#</a> 方法一：使用 mavenCentral 自动集成</h4> <p>该方法仅适用于 v3.8.2 或以上版本。</p> <ol><li>在项目的 <code>build.gradle</code> 中添加 <code>mavenCentral()</code>仓库。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code>buildscript <span class="token punctuation">{</span>
    repositories <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

allprojects <span class="token punctuation">{</span>
    repositories <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>在 <code>module</code> 的 <code>build.gradle</code> 中添加如下依赖：</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
dependencies <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// x.y.z 请填写具体版本号，如：3.9.4。</span>
    <span class="token comment">// 可通过 SDK 发版说明获得最新版本号。</span>
    implementation 'io<span class="token punctuation">.</span>hyphenate<span class="token operator">:</span>hyphenate<span class="token operator">-</span>chat<span class="token operator">:</span>x<span class="token punctuation">.</span>x<span class="token punctuation">.</span>x'
<span class="token punctuation">}</span>
</code></pre></div><p><strong>注意</strong></p> <p>如果使用 3.8.0 之前的版本，gradle 依赖需要按照下面格式添加：</p> <div class="language-java extra-class"><pre class="language-java"><code>implementation 'io<span class="token punctuation">.</span>hyphenate<span class="token operator">:</span>hyphenate<span class="token operator">-</span>sdk<span class="token operator">:</span><span class="token number">3.7</span><span class="token number">.5</span>' <span class="token comment">// 完整版本，包含音视频功能</span>

implementation 'io<span class="token punctuation">.</span>hyphenate<span class="token operator">:</span>hyphenate<span class="token operator">-</span>sdk<span class="token operator">-</span>lite<span class="token operator">:</span><span class="token number">3.7</span><span class="token number">.5</span>' <span class="token comment">// 精简版，只包含IM功能 </span>
</code></pre></div><h4 id="方法二-手动复制-sdk-文件"><a href="#方法二-手动复制-sdk-文件" class="header-anchor">#</a> 方法二：手动复制 SDK 文件</h4> <p>打开 SDK 下载页面，获取最新版的环信即时通讯 IM Android SDK，然后解压。</p> <p><img src="https://docs-im.easemob.com/lib/exe/fetch.php?w=200&amp;tok=211c9a&amp;media=https%3A%2F%2Fdocs-im.easemob.com%2F_media%2Fim%2Fandroid%2Fsdk%2Ff1a7b52fe99d623bd798b05566c46f3.png" alt="img"></p> <p>将 SDK 包内 libs 路径下的如下文件，拷贝到你的项目路径下：</p> <table><thead><tr><th style="text-align:left;">文件或文件夹</th> <th style="text-align:left;">项目路径</th></tr></thead> <tbody><tr><td style="text-align:left;">easemob_xxx.jar 文件</td> <td style="text-align:left;">/app/libs/</td></tr> <tr><td style="text-align:left;">arm64-v8a 文件夹</td> <td style="text-align:left;">/app/src/main/jniLibs/</td></tr> <tr><td style="text-align:left;">armeabi-v7a 文件夹</td> <td style="text-align:left;">/app/src/main/jniLibs/</td></tr> <tr><td style="text-align:left;">x86 文件夹</td> <td style="text-align:left;">/app/src/main/jniLibs/</td></tr> <tr><td style="text-align:left;">x86_64 文件夹</td> <td style="text-align:left;">/app/src/main/jniLibs/</td></tr></tbody></table> <p>如果对生成的 <code>apk</code> 大小比较敏感，我们建议使用 <code>jar</code> 方式，并且手工拷贝 <code>so</code>，而不是使用 <code>Aar</code>，因为 <code>Aar</code> 方式会把各个平台的 <code>so</code> 文件都包含在其中。采用 <code>jar</code> 方式，可以仅保留一个 <code>ARCH</code> 目录，建议仅保留 <code>armeabi-v7a</code>，这样虽然在对应平台执行的速度会降低，但是能有效减小 <code>apk</code> 的大小。</p> <h3 id="_3-添加项目权限"><a href="#_3-添加项目权限" class="header-anchor">#</a> 3. 添加项目权限</h3> <p>根据场景需要，在 /app/src/main/AndroidManifest.xml 文件中添加如下行，获取相应的设备权限：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span> encoding<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>manifest xmlns<span class="token operator">:</span>android<span class="token operator">=</span><span class="token string">&quot;http://schemas.android.com/apk/res/android&quot;</span>
    <span class="token keyword">package</span><span class="token operator">=</span><span class="token string">&quot;Your Package&quot;</span>
    android<span class="token operator">:</span>versionCode<span class="token operator">=</span><span class="token string">&quot;100&quot;</span>
    android<span class="token operator">:</span>versionName<span class="token operator">=</span><span class="token string">&quot;1.0.0&quot;</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> IM SDK required start <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 允许程序振动，用于本地通知设置振动 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.VIBRATE&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 访问网络权限 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.INTERNET&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 麦克风权限，用于语音消息时录制语音，不使用录制语音可以移除 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.RECORD_AUDIO&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 相机权限，用于图片消息时拍摄图片，不使用拍照可以移除 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.CAMERA&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 获取运营商信息，用于获取网络状态 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 写入扩展存储权限，用于附件等的存储 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.READ_EXTERNAL_STORAGE&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 访问 GPS 定位，用于定位消息，如果不用定位相关可以移除 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> api <span class="token number">21</span> 后被标记为 deprecated，可以移除 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.GET_TASKS&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 允许程序在手机屏幕关闭后后台进程仍然运行 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.WAKE_LOCK&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 允许程序开机自动运行，SDK 保活时使用，如果使用厂商推送，可以移除 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 申请闹钟定时权限 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.permission.SCHEDULE_EXACT_ALARM&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> IM SDK required end <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>application<span class="token punctuation">&gt;</span></span>

        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 声明 SDK 所需的 service 的核心功能<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>service
            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;com.hyphenate.chat.EMChatService&quot;</span>
            android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">&quot;true&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>service
            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;com.hyphenate.chat.EMJobService&quot;</span>
            android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
            android<span class="token operator">:</span>permission<span class="token operator">=</span><span class="token string">&quot;android.permission.BIND_JOB_SERVICE&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 声明 SDK 所需的 receiver <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>receiver
            android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;com.hyphenate.chat.EMMonitorReceiver&quot;</span>
            android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">&quot;false&quot;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.intent.action.PACKAGE_REMOVED&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>data android<span class="token operator">:</span>scheme<span class="token operator">=</span><span class="token string">&quot;package&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 可选 filter <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.intent.action.BOOT_COMPLETED&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">&quot;android.intent.action.USER_PRESENT&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>receiver<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>application<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>manifest<span class="token operator">&gt;</span>
</code></pre></div><p>关于 App Key 对应的 value 获取，在 <a href="https://console.easemob.com/user/login" target="_blank" rel="noopener noreferrer">环信即时通讯 IM 管理后台<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 创建应用后，申请 App Key 并进行相关配置。</p> <h3 id="_4-防止代码混淆"><a href="#_4-防止代码混淆" class="header-anchor">#</a> 4. 防止代码混淆</h3> <p>在 app/proguard-rules.pro 文件中添加如下行，防止混淆 SDK 的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">-</span>keep <span class="token keyword">class</span> com<span class="token punctuation">.</span>hyphenate<span class="token punctuation">.</span>*<span class="token operator">*</span> <span class="token punctuation">{</span><span class="token operator">*</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token operator">-</span>dontwarn  com<span class="token punctuation">.</span>hyphenate<span class="token punctuation">.</span>*<span class="token operator">*</span>
</code></pre></div><h2 id="实现单聊"><a href="#实现单聊" class="header-anchor">#</a> 实现单聊</h2> <p>本节介绍如何实现单聊。</p> <h3 id="_1-sdk-初始化"><a href="#_1-sdk-初始化" class="header-anchor">#</a> 1. SDK 初始化</h3> <p>在主进程中进行初始化：</p> <div class="language- extra-class"><pre class="language-text"><code>EMOptions options = new EMOptions();
options.setAppKey(&quot;Your appkey&quot;);
......// 其他 EMOptions 配置。
EMClient.getInstance().init(context, options);
</code></pre></div><h3 id="_2-创建账号"><a href="#_2-创建账号" class="header-anchor">#</a> 2. 创建账号</h3> <p>可以使用如下代码创建账户：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 注册失败会抛出 HyphenateException。</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createAccount</span><span class="token punctuation">(</span>mAccount<span class="token punctuation">,</span> mPassword<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//同步方法。</span>
</code></pre></div><p><strong>注意</strong></p> <p>该注册模式为在客户端注册，主要用于测试，简单方便，但不推荐在正式环境中使用；正式环境中应使用服务器端调用 Restful API 注册，具体见：<a href="https://docs-im.easemob.com/ccim/rest/accountsystem#%E6%B3%A8%E5%86%8C%E5%8D%95%E4%B8%AA%E7%94%A8%E6%88%B7" target="_blank" rel="noopener noreferrer">注册单个用户<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="_3-登录账号"><a href="#_3-登录账号" class="header-anchor">#</a> 3. 登录账号</h3> <p>使用如下代码实现用户登录：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>mAccount<span class="token punctuation">,</span> mPassword<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EMCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 登录成功回调</span>
    <span class="token annotation punctuation">@Override</span> 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token comment">// 登录失败回调，包含错误信息</span>
    <span class="token annotation punctuation">@Override</span> 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span> 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意：</strong></p> <ol><li>除了注册监听器，其他的 SDK 操作均需在登录之后进行。</li> <li>登录成功后需要调用 <code>EMClient.getInstance().chatManager().loadAllConversations();</code> 和 <code>EMClient.getInstance().groupManager().loadAllGroups();</code>，确保进入主页面后本地会话和群组均加载完毕。</li> <li>如果之前登录过，App 长期在后台运行后切换到前台运行可能会导致加载到内存的群组和会话为空。为了避免这种情况，可在主页面的 <code>oncreate</code> 里也添加这两种方法，不过，最好将这两种方法放在程序的开屏页。</li></ol> <h3 id="_4-发送一条单聊消息"><a href="#_4-发送一条单聊消息" class="header-anchor">#</a> 4. 发送一条单聊消息</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// `content` 为要发送的文本内容，`toChatUsername` 为对方的账号。</span>
<span class="token class-name">EMMessage</span> message <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createTxtSendMessage</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> toChatUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 发送消息</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="参考信息"><a href="#参考信息" class="header-anchor">#</a> 参考信息</h2> <h3 id="android-sdk-介绍"><a href="#android-sdk-介绍" class="header-anchor">#</a> Android SDK 介绍</h3> <p>环信 IM SDK 为用户开发 IM 相关的应用提供的一套完善的开发框架。包括以下几个部分：</p> <p><img src="https://docs-im.easemob.com/_media/im/android/sdk/development-framework.png" alt="img"></p> <ul><li>SDK_Core 为核心的消息同步协议实现，完成与服务器之间的信息交换。</li> <li>SDK 是基于核心协议实现的完整的 IM 功能，实现了不同类型消息的收发、会话管理、群组、好友、聊天室、子区等功能。</li> <li>EaseIMKit 是一组 IM 相关的 UI 控件，旨在帮助开发者快速集成环信 SDK。</li></ul> <p>开发者可以基于 EaseIMKit 或者环信 SDK 开发自己的应用，前者因为把消息的发送接送等功能封装到了内部，集成时开发者不需要太关心消息是怎么发送、怎么接收等逻辑。请查阅 <a href="https://docs-im.easemob.com/ccim/android/easeimkit" target="_blank" rel="noopener noreferrer">EaseIMKit 使用指南<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>SDK 采用模块化设计，每一模块的功能相对独立和完善，用户可以根据自己的需求选择使用下面的模块：</p> <p><img src="https://docs-im.easemob.com/_media/im/android/sdk/image005.png" alt="模块化设计"></p> <ul><li><code>EMClient</code>: SDK 的入口，主要完成登录、退出、连接管理等功能。也是获取其他模块的入口。</li> <li><code>EMChatManager</code>: 管理消息的收发，完成会话管理等功能。</li> <li><code>EMContactManager</code>: 负责好友的添加删除，黑名单的管理。</li> <li><code>EMGroupManager</code>: 负责群组的管理，如创建、删除群组，管理群组成员等功能。</li> <li><code>EMChatroomManager</code>: 负责聊天室的管理。</li></ul> <h3 id="sdk-目录讲解"><a href="#sdk-目录讲解" class="header-anchor">#</a> SDK 目录讲解</h3> <p>从官网上下载下来的包，解压后内容如下：</p> <p><img src="https://docs-im.easemob.com/_media/im/android/sdk/f1a7b52fe99d623bd798b05566c46f3.png?w=200&amp;tok=ed406e" alt="img"></p> <p>在这里主要介绍后面四个文件夹内容：</p> <ul><li>doc 文件夹：SDK 相关 API 文档</li> <li>examples 文件夹：EaseIm3.0</li> <li>libs 文件夹：包含 IM 功能所需要的 jar 和 so 文件</li></ul> <h3 id="第三方库介绍"><a href="#第三方库介绍" class="header-anchor">#</a> 第三方库介绍</h3> <h4 id="sdk-中用到的第三方库"><a href="#sdk-中用到的第三方库" class="header-anchor">#</a> SDK 中用到的第三方库</h4> <ul><li><code>android-support-v4.jar</code>：这个可以说是每个 APP 中都是不可缺少的 jar 包，这里不多赘述</li> <li><code>org.apache.http.legacy.jar</code>：在 3.6.8 版本以后 SDK 移除了这个 jar 包；在 3.6.8 之前的版本用这个库兼容，建议不要删除，否则在 6.0 系统中，SDK 会有问题</li></ul> <h4 id="easeimkit-中用到的第三方库"><a href="#easeimkit-中用到的第三方库" class="header-anchor">#</a> EaseIMKit 中用到的第三方库</h4> <ul><li>glide-4.9.0：图片处理库，显示用户头像时用到</li> <li>BaiduLBS_Android.jar：百度地图的 jar 包，在 3.8.5 版本中移除地图的相关 so 文件，jar 包仅用于编译。依赖本地 EaseIMKit 库时，如果不用百度地图，可以不在 module 中添加百度地图的相关 jar 包及 so 文件，并移除地图的相关扩展功能（具体可参考 <a href="https://docs-im.easemob.com/ccim/android/easeimkit#%E5%A2%9E%E5%8A%A0%E6%9B%B4%E5%A4%9A%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD" target="_blank" rel="noopener noreferrer">增加更多扩展功能<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <h3 id="sdk-中相关异步-同步处理方法介绍"><a href="#sdk-中相关异步-同步处理方法介绍" class="header-anchor">#</a> SDK 中相关异步/同步处理方法介绍</h3> <ul><li>同步方法：SDK 里大部分方法都为同步方法，即该方法执行完毕，才会走后面的代码。</li> <li>异步方法：带有 callback 以及 API 注释里明确写明异步方法的方法，即不需要等该方法执行完毕，后边的代码也可以执行，通过 callback 得到方法执行的结果。</li></ul> <h3 id="取本地-log"><a href="#取本地-log" class="header-anchor">#</a> 取本地 log</h3> <p>以 Demo 为例，获取本地的 log</p> <div class="language-java extra-class"><pre class="language-java"><code>adb pull <span class="token operator">/</span>sdcard<span class="token operator">/</span><span class="token class-name">Android</span><span class="token operator">/</span>data<span class="token operator">/</span>com<span class="token punctuation">.</span>hyphenate<span class="token punctuation">.</span>chatuidemo<span class="token operator">/</span>easemob<span class="token operator">-</span>demo#chatdemoui<span class="token operator">/</span>core_log<span class="token operator">/</span>easemob<span class="token punctuation">.</span>log
</code></pre></div><p>其中 <code>com.hyphenate.chatuidemo</code> 是 packagename，<code>easemob-demo#chatdemoui</code> 是 App Key，需要替换成自己对应的路径。</p> <h3 id="自动登录"><a href="#自动登录" class="header-anchor">#</a> 自动登录</h3> <p>即首次登录成功后，不需要再次调用登录方法，在下次 APP 启动时，SDK 会自动进行用户登录。并且如果用户自动登录失败，也可以读取到之前的会话信息（以上情况是在未调用登出的情况下实现的）。</p> <p>SDK 中自动登录属性默认是 <code>true</code> 打开的，如果不需要自动登录，在初始化 SDK 初始化的时候，调用 <code>options.setAutoLogin(false);</code> 设置为 <code>false</code> 关闭。</p> <p>自动登录在以下几种情况下会被取消：</p> <ul><li>用户调用了 SDK 的登出动作；</li> <li>用户在别的设备上更改了密码，导致此设备上自动登录失败；</li> <li>用户的账号被从服务器端删除；</li> <li>用户从另一个设备登录，把当前设备上登录的用户踢出。</li></ul> <h3 id="退出登录"><a href="#退出登录" class="header-anchor">#</a> 退出登录</h3> <p>同步方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>异步方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EMCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token keyword">int</span> progress<span class="token punctuation">,</span> <span class="token class-name">String</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果集成了 FCM 等第三方推送，方法里第一个参数需要设为 <code>true</code>，这样退出的时候会解绑设备 token，否则可能会出现退出了，还能收到消息的现象。</p> <p>部分时候可能碰到网络问题而解绑失败，app 处理时可以弹出提示框让用户选择，是否继续退出(弹出框提示继续退出能收到消息的风险)，如果用户选择继续退出，传 <code>false</code> 再调用 <code>logout</code> 方法退出成功。</p> <p>当然也可以失败后还是返回退出成功，然后在后台起个线程不断调用 <code>logout</code> 方法直到成功，这样有个风险：用户杀死了 app，然后网络恢复，用户还是会继续收到消息。</p> <p>另需要注意：如果调用异步退出方法，建议在收到 <code>onsucess</code> 的回调后再调用 IM 相关的方法，比如 <code>login</code>。</p> <h3 id="用户被封禁后的提示"><a href="#用户被封禁后的提示" class="header-anchor">#</a> 用户被封禁后的提示</h3> <p>在 <a href="http://console.easemob.com/" target="_blank" rel="noopener noreferrer">环信即时通讯 IM 管理后台<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 可以对用户进行管理，例如可以在后台封禁用户。用户被封禁后会提示 SDK 登录会返回 <code>SERVER_SERVING_DISABLED(305)</code>，可以根据用户该方法的返回值来进行相应提示或者处理。</p> <p>需要注意的是 app 整个被禁用时也会返回上述错误码，由于 app 一般不会被禁用，所以可以用来提示用户被封禁。</p> <h3 id="注册连接状态监听"><a href="#注册连接状态监听" class="header-anchor">#</a> 注册连接状态监听</h3> <p>当掉线时，Android SDK 会自动重连，无需进行任何操作，你可以通过注册连接监听来确认连接状态。</p> <ul><li>可以根据 <code>disconnect</code> 返回的 error 判断原因。若服务器返回的参数值为<code>EMError.USER_LOGIN_ANOTHER_DEVICE</code>，则认为是有同一个账号异地登录；若服务器返回的参数值为 <code>EMError.USER_REMOVED</code>，则是账号在后台被删除。</li> <li>被踢下线、被封禁等错误发生后，SDK 不会尝试重新连接，需要调用 <code>logout</code> 退出登录之后才能进行重新登录。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 注册连接状态监听</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addConnectionListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyConnectionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 实现 ConnectionListener 接口</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MyConnectionListener</span> <span class="token keyword">implements</span> <span class="token class-name">EMConnectionListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDisconnected</span><span class="token punctuation">(</span><span class="token keyword">int</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EMLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;global listener&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;onDisconnect&quot;</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name">EMError</span><span class="token punctuation">.</span>USER_REMOVED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onUserException</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>ACCOUNT_REMOVED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name">EMError</span><span class="token punctuation">.</span>USER_LOGIN_ANOTHER_DEVICE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onUserException</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>ACCOUNT_CONFLICT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name">EMError</span><span class="token punctuation">.</span>SERVER_SERVICE_RESTRICTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onUserException</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>ACCOUNT_FORBIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name">EMError</span><span class="token punctuation">.</span>USER_KICKED_BY_CHANGE_PASSWORD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onUserException</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>ACCOUNT_KICKED_BY_CHANGE_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token class-name">EMError</span><span class="token punctuation">.</span>USER_KICKED_BY_OTHER_DEVICE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">onUserException</span><span class="token punctuation">(</span><span class="token class-name">Constant</span><span class="token punctuation">.</span>ACCOUNT_KICKED_BY_OTHER_DEVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onLogout</span><span class="token punctuation">(</span><span class="token keyword">int</span> errorCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理需要用户退出到登录页面的场景</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


    <span class="token comment">// 遇到用户异常情况时的处理示例，例如存日志，加标签，退出登录，跳转到登录页面等。</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onUserException</span><span class="token punctuation">(</span><span class="token class-name">String</span> exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">EMLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;onUserException: &quot;</span> <span class="token operator">+</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Intent</span> intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span>FLAG_ACTIVITY_RESET_TASK_IF_NEEDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        appContext<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">showToast</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div></div> <div class="back-to-top hidden"></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/maniacflow/vuepress/edit/master/docs/document/Android/quick_start_android.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated">更新时间：2022/7/26 下午6:26:25</div></div></div></div> <link id="code-theme" rel="stylesheet"></div><div class="global-ui"></div></div>
    <script src="/vuepress/assets/js/app.3775eb30.js" defer></script><script src="/vuepress/assets/js/3.db456b6c.js" defer></script><script src="/vuepress/assets/js/1.7ac2d96d.js" defer></script><script src="/vuepress/assets/js/27.5accaed6.js" defer></script>
  </body>
</html>
