<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息管理–发送和接收消息 | 环信 IM 文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepress/logo.png">
    <meta name="description" content="环信即时通讯云最新集成文档，一天内即可帮APP快速集成聊天功能。 环信客户互动云集成文档，快速多渠道集成，为企业提供智能客服系统。">
    
    <link rel="preload" href="/vuepress/assets/css/0.styles.7ff8f1d4.css" as="style"><link rel="preload" href="/vuepress/assets/js/app.3775eb30.js" as="script"><link rel="preload" href="/vuepress/assets/js/3.db456b6c.js" as="script"><link rel="preload" href="/vuepress/assets/js/1.7ac2d96d.js" as="script"><link rel="preload" href="/vuepress/assets/js/22.6674015c.js" as="script"><link rel="prefetch" href="/vuepress/assets/js/10.e8437e28.js"><link rel="prefetch" href="/vuepress/assets/js/11.9fe3bf56.js"><link rel="prefetch" href="/vuepress/assets/js/12.5bdc7cb4.js"><link rel="prefetch" href="/vuepress/assets/js/13.fd9a688c.js"><link rel="prefetch" href="/vuepress/assets/js/14.c5d1ee43.js"><link rel="prefetch" href="/vuepress/assets/js/15.6249d44e.js"><link rel="prefetch" href="/vuepress/assets/js/16.e2333c54.js"><link rel="prefetch" href="/vuepress/assets/js/17.a016e123.js"><link rel="prefetch" href="/vuepress/assets/js/18.a4e71e3e.js"><link rel="prefetch" href="/vuepress/assets/js/19.c2a72fc0.js"><link rel="prefetch" href="/vuepress/assets/js/20.5ef4c978.js"><link rel="prefetch" href="/vuepress/assets/js/21.f02692d3.js"><link rel="prefetch" href="/vuepress/assets/js/23.7270cb71.js"><link rel="prefetch" href="/vuepress/assets/js/24.24b1ec9d.js"><link rel="prefetch" href="/vuepress/assets/js/25.d5729017.js"><link rel="prefetch" href="/vuepress/assets/js/26.48b974ea.js"><link rel="prefetch" href="/vuepress/assets/js/27.5accaed6.js"><link rel="prefetch" href="/vuepress/assets/js/28.0263440e.js"><link rel="prefetch" href="/vuepress/assets/js/29.598a97cf.js"><link rel="prefetch" href="/vuepress/assets/js/30.c348f978.js"><link rel="prefetch" href="/vuepress/assets/js/31.e8ccf099.js"><link rel="prefetch" href="/vuepress/assets/js/32.0e645f12.js"><link rel="prefetch" href="/vuepress/assets/js/33.24a50465.js"><link rel="prefetch" href="/vuepress/assets/js/34.ff18a349.js"><link rel="prefetch" href="/vuepress/assets/js/35.4e68b9ba.js"><link rel="prefetch" href="/vuepress/assets/js/36.efabe680.js"><link rel="prefetch" href="/vuepress/assets/js/37.662d4795.js"><link rel="prefetch" href="/vuepress/assets/js/38.126de51e.js"><link rel="prefetch" href="/vuepress/assets/js/39.95565ede.js"><link rel="prefetch" href="/vuepress/assets/js/4.e2bccb64.js"><link rel="prefetch" href="/vuepress/assets/js/40.6de23b15.js"><link rel="prefetch" href="/vuepress/assets/js/41.6d31188a.js"><link rel="prefetch" href="/vuepress/assets/js/42.f3454cae.js"><link rel="prefetch" href="/vuepress/assets/js/43.785e27a0.js"><link rel="prefetch" href="/vuepress/assets/js/44.2732245f.js"><link rel="prefetch" href="/vuepress/assets/js/45.aa9d062b.js"><link rel="prefetch" href="/vuepress/assets/js/46.f1767cea.js"><link rel="prefetch" href="/vuepress/assets/js/47.6ea90c89.js"><link rel="prefetch" href="/vuepress/assets/js/48.56a5e7e6.js"><link rel="prefetch" href="/vuepress/assets/js/49.8203ac0c.js"><link rel="prefetch" href="/vuepress/assets/js/5.05775f0d.js"><link rel="prefetch" href="/vuepress/assets/js/50.30fd124a.js"><link rel="prefetch" href="/vuepress/assets/js/51.6e8fe59e.js"><link rel="prefetch" href="/vuepress/assets/js/52.3d80ae80.js"><link rel="prefetch" href="/vuepress/assets/js/53.71b8512d.js"><link rel="prefetch" href="/vuepress/assets/js/6.7df3bdd1.js"><link rel="prefetch" href="/vuepress/assets/js/7.0be7f205.js"><link rel="prefetch" href="/vuepress/assets/js/8.5daa8986.js"><link rel="prefetch" href="/vuepress/assets/js/9.08e122ea.js">
    <link rel="stylesheet" href="/vuepress/assets/css/0.styles.7ff8f1d4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div><div class="header-container"><div class="logo"><a href="/vuepress/" class="router-link-active"><span><img src="/vuepress/logo.png"></span> <h1>环信 IM 文档</h1></a></div> <div class="nav pc-nav"><div class="main-nav"><a href="/vuepress/product/introduction.html">产品简介</a><a href="/vuepress/document/Android/quickstart" class="active">集成文档</a><a href="/vuepress/api/Android">API 参考</a></div> <div class="nav-extra"><div class="search-container"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="secondary-nav"><a href="https://console.easemob.com/ticket" target="_blank">提交工单</a></div> <div class="switch-lang"><a href="javascript:;">选择语言<span class="triangle"></span></a> <div id="sub-menu" class="sub-menu menu-hidden"><ul><li class="active"><a href="/vuepress/document/Android/message_send_receive.html" aria-current="page" class="router-link-exact-active router-link-active">简体中文</a></li><li><a href="/vuepress/en/document/Android/message_send_receive.html">English</a></li></ul></div></div> <div class="login-register"><a href="https://console.easemob.com/user/login" target="_blank">登录</a><a href="https://console.easemob.com/user/register" target="_blank">注册</a></div></div></div> <div class="mobile-nav"><img src="/vuepress/icon-menu.png"></div></div> <!----> <!----></div> <div class="content-container"><div class="sider-container"><div class="platform"><div class="platform-input"><div class="platform-text"><img src="/vuepress/icon-Android-hover.svg" alt> <span>Android</span></div> <div class="select-icon"><i class="icon-arrow"></i></div></div> <div id="platform-list" class="platform-list menu-hidden"><!----><div class="group"><div class="group-title">平台</div> <div class="options"><div data-key="Android" class="option-item"><img src="/vuepress/icon-Android.svg" alt class="default"> <img src="/vuepress/icon-Android-hover.svg" alt class="active"> <span>Android</span></div><div data-key="iOS" class="option-item"><img src="/vuepress/icon-iOS.svg" alt class="default"> <img src="/vuepress/icon-iOS-hover.svg" alt class="active"> <span>iOS</span></div><div data-key="Web" class="option-item"><img src="/vuepress/icon-web.svg" alt class="default"> <img src="/vuepress/icon-web-hover.png" alt class="active"> <span>Web</span></div><div data-key="Windows" class="option-item"><img src="/vuepress/icon-windows.svg" alt class="default"> <img src="/vuepress/icon-windows-hover.svg" alt class="active"> <span>Windows</span></div></div></div><div class="group"><div class="group-title">框架</div> <div class="options"><div data-key="Mini-program" class="option-item"><img src="/vuepress/icon-mini-program.svg" alt class="default"> <img src="/vuepress/icon-mini-program-hover.svg" alt class="active"> <span>小程序</span></div><div data-key="Flutter" class="option-item"><img src="/vuepress/icon-flutter.svg" alt class="default"> <img src="/vuepress/icon-flutter-hover.png" alt class="active"> <span>Flutter</span></div><div data-key="React-Native" class="option-item"><img src="/vuepress/icon-ReactNative.svg" alt class="default"> <img src="/vuepress/icon-ReactNative-hover.svg" alt class="active"> <span>React Native</span></div></div></div><div class="group"><div class="group-title"></div> <div class="options"><div data-key="Server-side" class="option-item"><img src="/vuepress/icon-server-dark.png" alt class="default"> <img src="/vuepress/icon-server-light.png" alt class="active"> <span>服务端</span></div></div></div></div></div> <div class="sider-menu"><div class="item"><h2>快速开始</h2> <ul><li><a href="/vuepress/document/Android/demo_android.html">Demo（EaseIM App）</a></li><li><a href="/vuepress/document/Android/quick_start_android.html">快速开始（不使用 EaseIMKIT）</a></li></ul></div><div class="item"><h2>基础功能</h2> <ul><li><div><a href="javascript:;">消息管理<i class="icon-arrow open"></i></a> <ul class="sider-menu-sub collapsable"><li><a href="/vuepress/document/Android/message_overview_android.html">消息概述</a></li><li class="active"><a href="/vuepress/document/Android/message_send_receive_android.html">发送和接收消息</a></li><li><a href="/vuepress/document/Android/message_manage_android.html">管理本地消息数据</a></li><li><a href="/vuepress/document/Android/message_retrieve_android.html">从服务器获取消息（消息漫游）</a></li><li><a href="/vuepress/document/Android/message_receipt_android.html">管理消息回执</a></li><li><a href="/vuepress/document/Android/message_translation_android.html">翻译</a></li></ul></div></li><li><a href="/vuepress/document/Android/userprofile_android.html">管理用户属性</a></li><li><a href="/vuepress/document/Android/user_relationship_android.html">管理用户关系</a></li><li><div><a href="javascript:;">群组管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/group_overview_android.html">群组概述</a></li><li><a href="/vuepress/document/Android/group_manage_android.html">管理群组</a></li><li><a href="/vuepress/document/Android/group_members_android.html">管理群组成员</a></li><li><a href="/vuepress/document/Android/group_attributes_android.html">管理群组属性</a></li></ul></div></li><li><div><a href="javascript:;">聊天室管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/room_overview_android.html">聊天室概述</a></li><li><a href="/vuepress/document/Android/room_manage_android.html">创建和管理聊天室</a></li><li><a href="/vuepress/document/Android/room_members_android.html">管理聊天室成员</a></li><li><a href="/vuepress/document/Android/room_attributes_android.html">管理聊天室属性</a></li></ul></div></li></ul></div><div class="item"><h2>进阶功能</h2> <ul><li><a href="/vuepress/document/Android/multi_device_android.html">登录多个设备</a></li><li><a href="/vuepress/document/Android/presence_android.html">管理在线状态订阅</a></li><li><a href="/vuepress/document/Android/reaction_android.html">消息表情回复</a></li><li><div><a href="javascript:;">子区管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/thread_android.html">管理子区</a></li><li><a href="/vuepress/document/Android/thread_message_android.html">管理子区消息</a></li></ul></div></li><li><a href="/vuepress/document/Android/moderation_report_android.html">消息审核</a></li></ul></div><div class="item"><h2>其他</h2> <ul><li><a href="/vuepress/document/Android/error_android.html">错误码</a></li></ul></div></div></div> <div data-key="v-70eef46e" class="description-container"><div><div class="content__default"><h1 id="消息管理-发送和接收消息"><a href="#消息管理-发送和接收消息" class="header-anchor">#</a> 消息管理–发送和接收消息</h1> <p></p><div class="table-of-contents"><ul><li><a href="#技术原理">技术原理</a></li><li><a href="#前提条件">前提条件</a></li><li><a href="#实现方法">实现方法</a><ul><li><a href="#发送文本消息">发送文本消息</a></li><li><a href="#接收消息">接收消息</a></li><li><a href="#撤回消息">撤回消息</a></li><li><a href="#设置消息撤回监听">设置消息撤回监听</a></li><li><a href="#发送附件类型的消息">发送附件类型的消息</a></li><li><a href="#发送位置消息">发送位置消息</a></li><li><a href="#发送透传消息">发送透传消息</a></li><li><a href="#发送自定义类型消息">发送自定义类型消息</a></li><li><a href="#使用消息的扩展字段">使用消息的扩展字段</a></li><li><a href="#更多操作">更多操作</a></li></ul></li></ul></div><p></p> <p>登录 Chat app 后，用户可以在单聊、群聊、聊天室中发送如下类型的消息：</p> <ul><li>文字消息，包含超链接和表情消息。</li> <li>附件消息，包含图片、语音、视频及文件消息。</li> <li>位置消息。</li> <li>CMD 消息。</li> <li>自定义消息。</li></ul> <p>以及对以上消息进行自定义扩展。
本文介绍如何使用即时通讯 IM Android SDK 实现发送和接收这些类型的消息。</p> <h2 id="技术原理"><a href="#技术原理" class="header-anchor">#</a> 技术原理</h2> <p>环信即时通讯 IM Android SDK 通过 <code>EMChatManager</code> 类和 <code>EMMessage</code> 类实现消息的发送、接收与撤回。</p> <p>其中，发送和接收消息的逻辑如下：</p> <ol><li>发送方调用相应 Create 方法创建文本、文件、附件等类型的消息；</li> <li>发送方再调用 <code>SendMessage</code> 发送消息；</li> <li>发送方可通过 <code>recallMessage</code> 撤回自己发出的消息；</li> <li>通过 <code>addMessageListener</code> 添加消息接收的回调通知。</li></ol> <p>消息收发流程如下：</p> <ol><li>用户 A 发送一条消息到环信的消息服务器;</li> <li>单聊时消息时，服务器投递消息给用户 B；对于群聊时消息，服务器投递给群内其他每一个成员;</li> <li>用户收到消息。</li></ol> <p><img src="https://docs-im.easemob.com/_media/ccim/web/sendandreceivemsg.png?w=800&amp;tok=54ca33" alt="img"></p> <h2 id="前提条件"><a href="#前提条件" class="header-anchor">#</a> 前提条件</h2> <p>开始前，请确保满足以下条件：</p> <ul><li>完成 SDK 初始化，详见 <a href="https://docs-im.easemob.com/ccim/android/quickstart" target="_blank" rel="noopener noreferrer">快速开始<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li>了解环信即时通讯 IM 的使用限制，详见 <a href="https://docs-im.easemob.com/ccim/limitation" target="_blank" rel="noopener noreferrer">使用限制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <h2 id="实现方法"><a href="#实现方法" class="header-anchor">#</a> 实现方法</h2> <h3 id="发送文本消息"><a href="#发送文本消息" class="header-anchor">#</a> 发送文本消息</h3> <ol><li>首先，利用 <code>EMMessage</code> 类构造一个消息。</li></ol> <p>示例代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 创建一条文本消息，`content` 为消息文字内容，`toChatUsername` 为对方用户或者群聊的 ID，后文皆是如此。</span>
<span class="token class-name">EMMessage</span> message <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createTxtSendMessage</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> toChatUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置消息类型，即设置 `Message` 类的 `ChatType` 属性。该属性的值为 `Chat`、`GroupChat` 和 `ChatRoom`，表明该消息是单聊，群聊或聊天室消息，默认为单聊。若为群聊，设置 `ChatType` 为 `GroupChat`。</span>
message<span class="token punctuation">.</span><span class="token function">setChatType</span><span class="token punctuation">(</span><span class="token class-name">ChatType<span class="token punctuation">.</span>GroupChat</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>通过 <code>EMChatManager</code> 将该消息发出。发送消息时可以设置 <code>EMCallBack</code> 的实例，获取消息发送状态。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 发送消息。</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 发送消息时可以设置 `EMCallBack` 的实例，获得消息发送的状态。可以在该回调中更新消息的显示状态。例如消息发送失败后的提示等等。</span>
message<span class="token punctuation">.</span><span class="token function">setMessageStatusCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EMCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          dialog<span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token keyword">int</span> progress<span class="token punctuation">,</span> <span class="token class-name">String</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token punctuation">}</span>

 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="接收消息"><a href="#接收消息" class="header-anchor">#</a> 接收消息</h3> <p>你可以用注册监听 <code>EMMessageListener</code> 接收消息。</p> <p>该 <code>EMMessageListener</code> 可以多次添加，请记得在不需要的时候移除 <code>listener</code>，如在 <code>activity</code> 的 <code>onDestroy()</code> 时。</p> <p>在新消息到来时，你会收到 <code>onMessageReceived</code> 的回调，消息接收时可能是一条，也可能是多条。你可以在该回调里遍历消息队列，解析并显示收到的消息。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMMessageListener</span> msgListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EMMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token comment">// 收到消息，遍历消息队列，解析和显示。</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessageReceived</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>

   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>msgListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeMessageListener</span><span class="token punctuation">(</span>msgListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="撤回消息"><a href="#撤回消息" class="header-anchor">#</a> 撤回消息</h3> <p>消息发送后 2 分钟之内，消息的发送方可以撤回该消息。如果需要调整可撤回时限，可以联系商务。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">recallMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EMLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;TAG&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;撤回消息成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">EMException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EMLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">&quot;TAG&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;撤回消息失败的原因: &quot;</span><span class="token operator">+</span>e<span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>或者用异步方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aysncRecallMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EMLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">&quot;TAG&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;撤回消息成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">int</span> errorCode<span class="token punctuation">,</span> <span class="token class-name">String</span> errorMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EMLog</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token string">&quot;TAG&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;撤回消息失败的原因: &quot;</span><span class="token operator">+</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="设置消息撤回监听"><a href="#设置消息撤回监听" class="header-anchor">#</a> 设置消息撤回监听</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * \~chinese
 * 接收到消息被撤回时触发此回调。
 *
 * \~english
 * Occurs when a received message is recalled.
 */</span>
<span class="token keyword">void</span> <span class="token function">onMessageRecalled</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ChatMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="发送附件类型的消息"><a href="#发送附件类型的消息" class="header-anchor">#</a> 发送附件类型的消息</h3> <p>除文本消息外，还有几种其他类型的消息，其中语音，图片，短视频，文件等消息，是通过先将附件上传到消息服务器的方式实现。收到语音时，会自动下载，而图片和视频会自动下载缩略图。文件消息不会自动下载附件，接收方需调用下载附件的 API，具体实现参考下文。</p> <h4 id="发送语音消息"><a href="#发送语音消息" class="header-anchor">#</a> 发送语音消息</h4> <p>发送语音消息时，应用层需完成语音文件录制的功能，提供语音文件的 URI 和语音时长。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// `voiceUri` 为语音文件的本地资源标志符，`duration` 为语音时长（秒）。</span>
<span class="token class-name">EMMessage</span> message <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createVoiceSendMessage</span><span class="token punctuation">(</span>voiceUri<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> toChatUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置消息类型，即设置 `Message` 类的 `MessageType` 属性。</span>
    <span class="token comment">// 该属性的值为 `Chat`、`Group` 和 `Room`，表明该消息是单聊，群聊或聊天室消息，默认为单聊。</span>
    <span class="token comment">// 若为群聊，设置 `MessageType` 为 `Group`。</span>
    message<span class="token punctuation">.</span><span class="token function">setChatType</span><span class="token punctuation">(</span><span class="token class-name">ChatType<span class="token punctuation">.</span>GroupChat</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接收方收到语音消息后，参考如下示例代码获取语音消息的附件：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMVoiceMessageBody</span> voiceBody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EMVoiceMessageBody</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取语音文件在服务器的地址。</span>
<span class="token class-name">String</span> voiceRemoteUrl <span class="token operator">=</span> voiceBody<span class="token punctuation">.</span><span class="token function">getRemoteUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 本地语音文件的资源路径。</span>
<span class="token class-name">Uri</span> voiceLocalUri <span class="token operator">=</span> voiceBody<span class="token punctuation">.</span><span class="token function">getLocalUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意</strong></p> <p>适配 AndroidQ 及以上手机时，获取本地资源请调用 <code>voiceBody.getLocalUri()</code>，相应的 <code>voiceBody.getLocalUrl()</code> 方法已经被废弃。</p> <h4 id="发送图片消息"><a href="#发送图片消息" class="header-anchor">#</a> 发送图片消息</h4> <p>图片消息默认会被压缩后发出，可通过设置 <code>original</code> 参数为 <code>true</code> 发送原图。
参考如下示例代码，创建并接收图片消息：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// `imageUri` 为图片本地资源标志符，`false` 为不发送原图（默认超过 100 KB 的图片会压缩后发给对方），需要发送原图传 `true`。</span>
<span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createImageSendMessage</span><span class="token punctuation">(</span>imageUri<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> toChatUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果是群聊，设置 `ChatType` 为 `GroupChat`，该参数默认是单聊（`Chat`）。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>chatType <span class="token operator">==</span> CHATTYPE_GROUP<span class="token punctuation">)</span>
    message<span class="token punctuation">.</span><span class="token function">setChatType</span><span class="token punctuation">(</span><span class="token class-name">ChatType<span class="token punctuation">.</span>GroupChat</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 发送成功后，获取图片消息缩略图及附件。</span>
<span class="token class-name">EMImageMessageBody</span> imgBody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EMImageMessageBody</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从服务器端获取图片文件。</span>
<span class="token class-name">String</span> imgRemoteUrl <span class="token operator">=</span> imgBody<span class="token punctuation">.</span><span class="token function">getRemoteUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从服务器端获取图片缩略图。</span>
<span class="token class-name">String</span> thumbnailUrl <span class="token operator">=</span> imgBody<span class="token punctuation">.</span><span class="token function">getThumbnailUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从本地获取图片文件。</span>
<span class="token class-name">Uri</span> imgLocalUri <span class="token operator">=</span> imgBody<span class="token punctuation">.</span><span class="token function">getLocalUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从本地获取图片缩略图。</span>
<span class="token class-name">Uri</span> thumbnailLocalUri <span class="token operator">=</span> imgBody<span class="token punctuation">.</span><span class="token function">thumbnailLocalUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token operator">*</span>注意<span class="token operator">*</span><span class="token operator">*</span>

适配 <span class="token class-name">AndroidQ</span> 及以上手机时，获取本地资源请调用 `imgBody<span class="token punctuation">.</span><span class="token function">getLocalUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span>`，相应的 `imgBody<span class="token punctuation">.</span><span class="token function">getLocalUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>` 方法已经被废弃。
</code></pre></div><p>接收方如果设置了自动下载，即 <code>EMClient.getInstance().getOptions().getAutodownloadThumbnail()</code> 为 <code>true</code>，SDK 接收到消息后会下载缩略图；如果未设置自动下载，需主动调用 <code>EMClient.getInstance().chatManager().downloadThumbnail(message</code>) 下载。</p> <p>下载完成后，调用相应消息 <code>body</code> 的 <code>thumbnailLocalUri()</code> 去获取缩略图路径。</p> <h4 id="发送短视频消息"><a href="#发送短视频消息" class="header-anchor">#</a> 发送短视频消息</h4> <p>发送短视频消息时，应用层需要完成视频文件的选取或者录制。视频消息支持输入视频的首帧作为缩略图，也支持给出视频的时长作为参数，发送给接收方。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> thumbPath <span class="token operator">=</span> <span class="token function">getThumbPath</span><span class="token punctuation">(</span>videoUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EMMessage</span> message <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createVideoSendMessage</span><span class="token punctuation">(</span>videoUri<span class="token punctuation">,</span> thumbPath<span class="token punctuation">,</span> videoLength<span class="token punctuation">,</span> toChatUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接收方收到短视频消息后，SDK 默认会下载该视频消息的缩略图。</p> <p>使用 <code>EMClient.getInstance().getOptions().setAutoDownloadThumbnail(false)</code> 可以修改为不自动下载。</p> <p>如果未设置自动下载，需主动调用 <code>EMClient.getInstance().chatManager().downloadThumbnail(message</code>) 下载。</p> <p>短视频文件本身需要通过 <code>EMClient.getInstance().chatManager().downloadAttachment(message)</code> 下载，下载完成后，调用相应消息 body 的 <code>thumbnailLocalUri()</code> 获取缩略图路径。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * Downloads the video file.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">downloadVideo</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">EMMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">.</span><span class="token function">setMessageStatusCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EMCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> progress<span class="token punctuation">,</span><span class="token class-name">String</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> error<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">downloadAttachment</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>获取视频封面的服务器地址：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> thumbnailUrl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">EMVideoMessageBody</span><span class="token punctuation">)</span> body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getThumbnailUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>获取视频封面的本地资源路径：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Uri</span> localThumbUri <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">EMVideoMessageBody</span><span class="token punctuation">)</span> body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocalThumbUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="发送文件消息"><a href="#发送文件消息" class="header-anchor">#</a> 发送文件消息</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// `fileLocalUri` 为本地资源标志符。</span>
<span class="token class-name">EMMessage</span> message <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createFileSendMessage</span><span class="token punctuation">(</span>fileLocalUri<span class="token punctuation">,</span> toChatUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果是群聊，设置 `ChatType` 为 `GroupChat`，该参数默认是单聊（`Chat`）。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>chatType <span class="token operator">==</span> CHATTYPE_GROUP<span class="token punctuation">)</span>    message<span class="token punctuation">.</span><span class="token function">setChatType</span><span class="token punctuation">(</span><span class="token class-name">ChatType<span class="token punctuation">.</span>GroupChat</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>发送成功后，获取文件消息附件：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMNormalFileMessageBody</span> fileMessageBody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EMNormalFileMessageBody</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从服务器获取文件。</span>
<span class="token class-name">String</span> fileRemoteUrl <span class="token operator">=</span> fileMessageBody<span class="token punctuation">.</span><span class="token function">getRemoteUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从本地获取文件。</span>
<span class="token class-name">Uri</span> fileLocalUri <span class="token operator">=</span> fileMessageBody<span class="token punctuation">.</span><span class="token function">getLocalUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意</strong></p> <p>适配 AndroidQ 及以上手机时，获取本地资源请调用 <code>fileMessageBody.getLocalUri()</code>，相应的 <code>fileMessageBody.getLocalUrl()</code> 方法已经被废弃。</p> <p>发送附件类型消息时，可以在 <code>onProgress</code> 回调中获取附件上传的进度，以百分比表示，示例代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 发送消息时可以设置 `EMCallBack` 的实例，获得消息发送的状态。可以在该回调中更新消息的显示状态。例如，消息发送失败后的提示等等。</span>
 message<span class="token punctuation">.</span><span class="token function">setMessageStatusCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EMCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          dialog<span class="token punctuation">.</span><span class="token function">dismiss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">showToast</span><span class="token punctuation">(</span><span class="token string">&quot;发送消息失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

 <span class="token comment">// 消息发送的状态，这里只用于附件类型的消息。</span>
     <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token keyword">int</span> progress<span class="token punctuation">,</span> <span class="token class-name">String</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>


     <span class="token punctuation">}</span>

 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="下载缩略图及附件"><a href="#下载缩略图及附件" class="header-anchor">#</a> 下载缩略图及附件</h4> <p>图片消息和视频消息默认会生成缩略图，接收到图片消息，视频消息默认会自动下载缩略图。语音消息接收到后会自动下载。如果不想自动下载附件，可以通过配置修改，即修改 <code>EMClient.getInstance().getOptions().setAutoDownloadThumbnail(false)</code>。</p> <p>如果未设置自动下载，需主动调用 <code>EMClient.getInstance().chatManager().downloadThumbnail(message)</code> 下载。</p> <p>下载完成后，调用相应消息 body 的 <code>thumbnailLocalUri()</code> 获取缩略图路径。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 从服务器下载缩略图。</span>
<span class="token class-name">EMImageMessageBody</span> imgBody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EMImageMessageBody</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从本地获取图片缩略图。</span>
<span class="token class-name">Uri</span> thumbnailLocalUri <span class="token operator">=</span> imgBody<span class="token punctuation">.</span><span class="token function">thumbnailLocalUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下载附件</p> <p>下载附件的方法为：<code>EMClient.getInstance().chatManager().downloadAttachment(message)</code>;</p> <p>下载完成后，调用相应消息 body 的 <code>getLocalUri()</code> 获取附件路径。</p> <p>例如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMImageMessageBody</span> imgBody <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EMImageMessageBody</span><span class="token punctuation">)</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 从本地获取图片文件。</span>
<span class="token class-name">Uri</span> imgLocalUri <span class="token operator">=</span> imgBody<span class="token punctuation">.</span><span class="token function">getLocalUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="发送位置消息"><a href="#发送位置消息" class="header-anchor">#</a> 发送位置消息</h3> <p>当你需要发送位置时，需要集成第三方的地图服务，获取到位置点的经纬度信息。接收方接收到位置消息时，需要将该位置的经纬度，借由第三方的地图服务，将位置在地图上显示出来。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// `latitude` 为纬度，`longitude` 为经度，`locationAddress` 为具体位置内容。</span>
<span class="token class-name">EMMessage</span> message <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createLocationSendMessage</span><span class="token punctuation">(</span>latitude<span class="token punctuation">,</span> longitude<span class="token punctuation">,</span> locationAddress<span class="token punctuation">,</span> toChatUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果是群聊，设置 `ChatType` 为 `GroupChat`，该参数默认是单聊（`Chat`）。</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>chatType <span class="token operator">==</span> CHATTYPE_GROUP<span class="token punctuation">)</span>    message<span class="token punctuation">.</span><span class="token function">setChatType</span><span class="token punctuation">(</span><span class="token class-name">ChatType<span class="token punctuation">.</span>GroupChat</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="发送透传消息"><a href="#发送透传消息" class="header-anchor">#</a> 发送透传消息</h3> <p>透传消息可视为命令消息，通过发送这条命令给对方，通知对方要进行的操作，收到消息可以自定义处理。（透传消息不会存入本地数据库中，所以在 UI 上不会显示）。具体功能可以根据自身业务需求自定义，例如实现头像、昵称的更新等。另外，以 “em_” 和 “easemob::” 开头的 action 为内部保留字段，注意不要使用。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMMessage</span> cmdMsg <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createSendMessage</span><span class="token punctuation">(</span><span class="token class-name">EMMessage<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span>CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 支持单聊和群聊，默认单聊，如果是群聊添加下面这行。</span>
cmdMsg<span class="token punctuation">.</span><span class="token function">setChatType</span><span class="token punctuation">(</span><span class="token class-name">ChatType<span class="token punctuation">.</span>GroupChat</span><span class="token punctuation">)</span><span class="token class-name">String</span> action<span class="token operator">=</span><span class="token string">&quot;action1&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// `action` 可以自定义。</span>
<span class="token class-name">EMCmdMessageBody</span> cmdBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EMCmdMessageBody</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> toUsername <span class="token operator">=</span> <span class="token string">&quot;test1&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 发送给特定用户。</span>
cmdMsg<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>toUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>cmdMsg<span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span>cmdBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>cmdMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>请注意透传消息的接收方，也是由单独的回调进行通知，方便用户进行不同的处理。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMMessageListener</span> msgListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EMMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 收到消息。</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessageReceived</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 收到透传消息。</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCmdMessageReceived</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="发送自定义类型消息"><a href="#发送自定义类型消息" class="header-anchor">#</a> 发送自定义类型消息</h3> <p>除了几种消息之外，你可以自己定义消息类型，方便业务处理，即首先设置一个消息类型名称，然后可添加多种自定义消息。自定义消息内容是 key，value 格式，你需要自己添加并解析该内容。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMMessage</span> customMessage <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createSendMessage</span><span class="token punctuation">(</span><span class="token class-name">EMMessage<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span>CUSTOM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// `event` 为需要传递的自定义消息事件，比如礼物消息，可以设置：</span>
event <span class="token operator">=</span> <span class="token string">&quot;gift&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">EMCustomMessageBody</span> customBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EMCustomMessageBody</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// `params` 类型为 `Map&lt;String, String&gt;`。</span>
customBody<span class="token punctuation">.</span><span class="token function">setParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
customMessage<span class="token punctuation">.</span><span class="token function">addBody</span><span class="token punctuation">(</span>customBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// `to` 指另一方环信用户 ID（或者群组 ID，聊天室 ID）</span>
customMessage<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果是群聊，设置 `ChatType` 为 `GroupChat`，该参数默认是单聊（`Chat`）。</span>
customMessage<span class="token punctuation">.</span><span class="token function">setChatType</span><span class="token punctuation">(</span>chatType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>customMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="使用消息的扩展字段"><a href="#使用消息的扩展字段" class="header-anchor">#</a> 使用消息的扩展字段</h3> <p>当 SDK 提供的消息类型不满足需求时，你可以通过消息扩展字段传递自定义的内容，从而生成自己需要的消息类型。</p> <p>当目前消息类型不满足用户需求时，可以在扩展部分保存更多信息，例如消息中需要携带被回复的消息内容或者是图文消息等场景。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMMessage</span> message <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createTxtSendMessage</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> toChatUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 增加自定义属性。</span>
message<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;attribute1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
message<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;attribute2&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 接收消息的时候获取扩展属性。</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取自定义属性，第 2 个参数为没有此定义的属性时返回的默认值。</span>
message<span class="token punctuation">.</span><span class="token function">getStringAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;attribute1&quot;</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
message<span class="token punctuation">.</span><span class="token function">getBooleanAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;attribute2&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="更多操作"><a href="#更多操作" class="header-anchor">#</a> 更多操作</h3> <p>你可以参考如下文档，在项目中实现更多的消息相关功能：</p> <ul><li><a href="https://docs-im.easemob.com/ccim/android/message1" target="_blank" rel="noopener noreferrer">消息概述<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>;</li> <li><a href="https://docs-im.easemob.com/ccim/android/message3" target="_blank" rel="noopener noreferrer">管理本地消息数据<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li><a href="https://docs-im.easemob.com/ccim/android/message4" target="_blank" rel="noopener noreferrer">从服务器获取会话和消息（消息漫游）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li><a href="https://docs-im.easemob.com/ccim/android/message5" target="_blank" rel="noopener noreferrer">获取消息的已读回执和送达回执<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li><a href="https://docs-im.easemob.com/ccim/android/translation" target="_blank" rel="noopener noreferrer">实现翻译功能<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul></div> <div class="back-to-top hidden"></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/maniacflow/vuepress/edit/master/docs/document/Android/message_send_receive_android.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated">更新时间：2022/7/26 下午6:26:25</div></div></div></div> <link id="code-theme" rel="stylesheet"></div><div class="global-ui"></div></div>
    <script src="/vuepress/assets/js/app.3775eb30.js" defer></script><script src="/vuepress/assets/js/3.db456b6c.js" defer></script><script src="/vuepress/assets/js/1.7ac2d96d.js" defer></script><script src="/vuepress/assets/js/22.6674015c.js" defer></script>
  </body>
</html>
