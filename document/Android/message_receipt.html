<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消息管理–获取消息的已读回执和送达回执 | 环信 IM 文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepress/logo.png">
    <meta name="description" content="环信即时通讯云最新集成文档，一天内即可帮APP快速集成聊天功能。 环信客户互动云集成文档，快速多渠道集成，为企业提供智能客服系统。">
    
    <link rel="preload" href="/vuepress/assets/css/0.styles.7ff8f1d4.css" as="style"><link rel="preload" href="/vuepress/assets/js/app.3775eb30.js" as="script"><link rel="preload" href="/vuepress/assets/js/3.db456b6c.js" as="script"><link rel="preload" href="/vuepress/assets/js/1.7ac2d96d.js" as="script"><link rel="preload" href="/vuepress/assets/js/20.5ef4c978.js" as="script"><link rel="prefetch" href="/vuepress/assets/js/10.e8437e28.js"><link rel="prefetch" href="/vuepress/assets/js/11.9fe3bf56.js"><link rel="prefetch" href="/vuepress/assets/js/12.5bdc7cb4.js"><link rel="prefetch" href="/vuepress/assets/js/13.fd9a688c.js"><link rel="prefetch" href="/vuepress/assets/js/14.c5d1ee43.js"><link rel="prefetch" href="/vuepress/assets/js/15.6249d44e.js"><link rel="prefetch" href="/vuepress/assets/js/16.e2333c54.js"><link rel="prefetch" href="/vuepress/assets/js/17.a016e123.js"><link rel="prefetch" href="/vuepress/assets/js/18.a4e71e3e.js"><link rel="prefetch" href="/vuepress/assets/js/19.c2a72fc0.js"><link rel="prefetch" href="/vuepress/assets/js/21.f02692d3.js"><link rel="prefetch" href="/vuepress/assets/js/22.6674015c.js"><link rel="prefetch" href="/vuepress/assets/js/23.7270cb71.js"><link rel="prefetch" href="/vuepress/assets/js/24.24b1ec9d.js"><link rel="prefetch" href="/vuepress/assets/js/25.d5729017.js"><link rel="prefetch" href="/vuepress/assets/js/26.48b974ea.js"><link rel="prefetch" href="/vuepress/assets/js/27.5accaed6.js"><link rel="prefetch" href="/vuepress/assets/js/28.0263440e.js"><link rel="prefetch" href="/vuepress/assets/js/29.598a97cf.js"><link rel="prefetch" href="/vuepress/assets/js/30.c348f978.js"><link rel="prefetch" href="/vuepress/assets/js/31.e8ccf099.js"><link rel="prefetch" href="/vuepress/assets/js/32.0e645f12.js"><link rel="prefetch" href="/vuepress/assets/js/33.24a50465.js"><link rel="prefetch" href="/vuepress/assets/js/34.ff18a349.js"><link rel="prefetch" href="/vuepress/assets/js/35.4e68b9ba.js"><link rel="prefetch" href="/vuepress/assets/js/36.efabe680.js"><link rel="prefetch" href="/vuepress/assets/js/37.662d4795.js"><link rel="prefetch" href="/vuepress/assets/js/38.126de51e.js"><link rel="prefetch" href="/vuepress/assets/js/39.95565ede.js"><link rel="prefetch" href="/vuepress/assets/js/4.e2bccb64.js"><link rel="prefetch" href="/vuepress/assets/js/40.6de23b15.js"><link rel="prefetch" href="/vuepress/assets/js/41.6d31188a.js"><link rel="prefetch" href="/vuepress/assets/js/42.f3454cae.js"><link rel="prefetch" href="/vuepress/assets/js/43.785e27a0.js"><link rel="prefetch" href="/vuepress/assets/js/44.2732245f.js"><link rel="prefetch" href="/vuepress/assets/js/45.aa9d062b.js"><link rel="prefetch" href="/vuepress/assets/js/46.f1767cea.js"><link rel="prefetch" href="/vuepress/assets/js/47.6ea90c89.js"><link rel="prefetch" href="/vuepress/assets/js/48.56a5e7e6.js"><link rel="prefetch" href="/vuepress/assets/js/49.8203ac0c.js"><link rel="prefetch" href="/vuepress/assets/js/5.05775f0d.js"><link rel="prefetch" href="/vuepress/assets/js/50.30fd124a.js"><link rel="prefetch" href="/vuepress/assets/js/51.6e8fe59e.js"><link rel="prefetch" href="/vuepress/assets/js/52.3d80ae80.js"><link rel="prefetch" href="/vuepress/assets/js/53.71b8512d.js"><link rel="prefetch" href="/vuepress/assets/js/6.7df3bdd1.js"><link rel="prefetch" href="/vuepress/assets/js/7.0be7f205.js"><link rel="prefetch" href="/vuepress/assets/js/8.5daa8986.js"><link rel="prefetch" href="/vuepress/assets/js/9.08e122ea.js">
    <link rel="stylesheet" href="/vuepress/assets/css/0.styles.7ff8f1d4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div><div class="header-container"><div class="logo"><a href="/vuepress/" class="router-link-active"><span><img src="/vuepress/logo.png"></span> <h1>环信 IM 文档</h1></a></div> <div class="nav pc-nav"><div class="main-nav"><a href="/vuepress/product/introduction.html">产品简介</a><a href="/vuepress/document/Android/quickstart" class="active">集成文档</a><a href="/vuepress/api/Android">API 参考</a></div> <div class="nav-extra"><div class="search-container"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="secondary-nav"><a href="https://console.easemob.com/ticket" target="_blank">提交工单</a></div> <div class="switch-lang"><a href="javascript:;">选择语言<span class="triangle"></span></a> <div id="sub-menu" class="sub-menu menu-hidden"><ul><li class="active"><a href="/vuepress/document/Android/message_receipt.html" aria-current="page" class="router-link-exact-active router-link-active">简体中文</a></li><li><a href="/vuepress/en/document/Android/message_receipt.html">English</a></li></ul></div></div> <div class="login-register"><a href="https://console.easemob.com/user/login" target="_blank">登录</a><a href="https://console.easemob.com/user/register" target="_blank">注册</a></div></div></div> <div class="mobile-nav"><img src="/vuepress/icon-menu.png"></div></div> <!----> <!----></div> <div class="content-container"><div class="sider-container"><div class="platform"><div class="platform-input"><div class="platform-text"><img src="/vuepress/icon-Android-hover.svg" alt> <span>Android</span></div> <div class="select-icon"><i class="icon-arrow"></i></div></div> <div id="platform-list" class="platform-list menu-hidden"><!----><div class="group"><div class="group-title">平台</div> <div class="options"><div data-key="Android" class="option-item"><img src="/vuepress/icon-Android.svg" alt class="default"> <img src="/vuepress/icon-Android-hover.svg" alt class="active"> <span>Android</span></div><div data-key="iOS" class="option-item"><img src="/vuepress/icon-iOS.svg" alt class="default"> <img src="/vuepress/icon-iOS-hover.svg" alt class="active"> <span>iOS</span></div><div data-key="Web" class="option-item"><img src="/vuepress/icon-web.svg" alt class="default"> <img src="/vuepress/icon-web-hover.png" alt class="active"> <span>Web</span></div><div data-key="Windows" class="option-item"><img src="/vuepress/icon-windows.svg" alt class="default"> <img src="/vuepress/icon-windows-hover.svg" alt class="active"> <span>Windows</span></div></div></div><div class="group"><div class="group-title">框架</div> <div class="options"><div data-key="Mini-program" class="option-item"><img src="/vuepress/icon-mini-program.svg" alt class="default"> <img src="/vuepress/icon-mini-program-hover.svg" alt class="active"> <span>小程序</span></div><div data-key="Flutter" class="option-item"><img src="/vuepress/icon-flutter.svg" alt class="default"> <img src="/vuepress/icon-flutter-hover.png" alt class="active"> <span>Flutter</span></div><div data-key="React-Native" class="option-item"><img src="/vuepress/icon-ReactNative.svg" alt class="default"> <img src="/vuepress/icon-ReactNative-hover.svg" alt class="active"> <span>React Native</span></div></div></div><div class="group"><div class="group-title"></div> <div class="options"><div data-key="Server-side" class="option-item"><img src="/vuepress/icon-server-dark.png" alt class="default"> <img src="/vuepress/icon-server-light.png" alt class="active"> <span>服务端</span></div></div></div></div></div> <div class="sider-menu"><div class="item"><h2>快速开始</h2> <ul><li><a href="/vuepress/document/Android/demo_android.html">Demo（EaseIM App）</a></li><li><a href="/vuepress/document/Android/quick_start_android.html">快速开始（不使用 EaseIMKIT）</a></li></ul></div><div class="item"><h2>基础功能</h2> <ul><li><div><a href="javascript:;">消息管理<i class="icon-arrow open"></i></a> <ul class="sider-menu-sub collapsable"><li><a href="/vuepress/document/Android/message_overview_android.html">消息概述</a></li><li><a href="/vuepress/document/Android/message_send_receive_android.html">发送和接收消息</a></li><li><a href="/vuepress/document/Android/message_manage_android.html">管理本地消息数据</a></li><li><a href="/vuepress/document/Android/message_retrieve_android.html">从服务器获取消息（消息漫游）</a></li><li class="active"><a href="/vuepress/document/Android/message_receipt_android.html">管理消息回执</a></li><li><a href="/vuepress/document/Android/message_translation_android.html">翻译</a></li></ul></div></li><li><a href="/vuepress/document/Android/userprofile_android.html">管理用户属性</a></li><li><a href="/vuepress/document/Android/user_relationship_android.html">管理用户关系</a></li><li><div><a href="javascript:;">群组管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/group_overview_android.html">群组概述</a></li><li><a href="/vuepress/document/Android/group_manage_android.html">管理群组</a></li><li><a href="/vuepress/document/Android/group_members_android.html">管理群组成员</a></li><li><a href="/vuepress/document/Android/group_attributes_android.html">管理群组属性</a></li></ul></div></li><li><div><a href="javascript:;">聊天室管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/room_overview_android.html">聊天室概述</a></li><li><a href="/vuepress/document/Android/room_manage_android.html">创建和管理聊天室</a></li><li><a href="/vuepress/document/Android/room_members_android.html">管理聊天室成员</a></li><li><a href="/vuepress/document/Android/room_attributes_android.html">管理聊天室属性</a></li></ul></div></li></ul></div><div class="item"><h2>进阶功能</h2> <ul><li><a href="/vuepress/document/Android/multi_device_android.html">登录多个设备</a></li><li><a href="/vuepress/document/Android/presence_android.html">管理在线状态订阅</a></li><li><a href="/vuepress/document/Android/reaction_android.html">消息表情回复</a></li><li><div><a href="javascript:;">子区管理<i class="icon-arrow"></i></a> <ul class="sider-menu-sub collapsable menu-hidden"><li><a href="/vuepress/document/Android/thread_android.html">管理子区</a></li><li><a href="/vuepress/document/Android/thread_message_android.html">管理子区消息</a></li></ul></div></li><li><a href="/vuepress/document/Android/moderation_report_android.html">消息审核</a></li></ul></div><div class="item"><h2>其他</h2> <ul><li><a href="/vuepress/document/Android/error_android.html">错误码</a></li></ul></div></div></div> <div data-key="v-9bd5d006" class="description-container"><div><div class="content__default"><h1 id="消息管理-获取消息的已读回执和送达回执"><a href="#消息管理-获取消息的已读回执和送达回执" class="header-anchor">#</a> 消息管理–获取消息的已读回执和送达回执</h1> <p></p><div class="table-of-contents"><ul><li><a href="#技术原理">技术原理</a></li><li><a href="#前提条件">前提条件</a></li><li><a href="#实现方法">实现方法</a><ul><li><a href="#消息送达回执">消息送达回执</a></li><li><a href="#消息已读回执">消息已读回执</a></li><li><a href="#更多操作">更多操作</a></li></ul></li></ul></div><p></p> <p>用户在单聊中发送消息后，可以查看该消息的送达和已读状态，了解接收方是否及时收到并阅读了消息，也可以了解整个会话是否已读。</p> <p>用户在群聊中发送信息后，可以查看该消息的已读状态。</p> <p>本文介绍如何集成环信即时通讯 IM Android SDK 消息的已读回执和送达回执实现上述功能。</p> <h2 id="技术原理"><a href="#技术原理" class="header-anchor">#</a> 技术原理</h2> <p>使用环信即时通讯 IM SDK 可以实现消息的送达回执与已读回执，核心方法如下：</p> <ul><li><code>setRequireDeliveryAck</code> 开启送达回执；</li> <li><code>ackConversationRead</code> 发出指定会话的已读回执；</li> <li><code>ackMessageRead</code> 发出指定消息的已读回执；</li> <li><code>ackGroupMessageRead</code> 发出群组消息的已读回执。</li></ul> <p>送达和已读回执逻辑分别如下：</p> <p>单聊消息送达回执：</p> <ol><li>消息发送方在发送消息前通过 <code>Options.setRequireDeliveryAck</code> 开启送达回执功能；</li> <li>消息接收方收到消息后，SDK 自动向发送方触发送达回执；</li> <li>消息发送方通过监听 <code>OnMessageDelivered</code> 回调接收消息送达回执。</li></ol> <p>已读回执：</p> <ul><li><p>单聊会话及消息已读回执</p> <ol><li>调用 <code>setRequireAck(boolean)</code> 设置需要发送已读回执，传 <code>true</code>；</li> <li>消息接收方收到消息后，调用 API <code>ackConversationRead</code> 或 <code>ackMessageRead</code> 发送会话或消息已读回执；</li> <li>消息发送方通过监听 <code>OnConversationRead</code> 或 <code>OnMessageRead</code> 回调接收会话或消息已读回执。</li></ol></li> <li><p>群聊只支持消息已读回执：</p> <ol><li>你可以通过设置 <code>isNeedGroupAck</code> 为 <code>true</code> 开启群聊消息已读回执功能；</li> <li>消息接收方收到消息后通过 <code>ackGroupMessageRead</code> 发送群组消息的已读回执。</li></ol></li></ul> <h2 id="前提条件"><a href="#前提条件" class="header-anchor">#</a> 前提条件</h2> <p>开始前，请确保满足以下条件：</p> <ul><li>完成 SDK 初始化，并连接到服务器，详见 <a href="https://docs-im.easemob.com/ccim/android/quickstart" target="_blank" rel="noopener noreferrer">快速开始<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li> <li>了解环信即时通讯 IM 的使用限制，详见 <a href="https://docs-im.easemob.com/ccim/limitation" target="_blank" rel="noopener noreferrer">使用限制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <h2 id="实现方法"><a href="#实现方法" class="header-anchor">#</a> 实现方法</h2> <h3 id="消息送达回执"><a href="#消息送达回执" class="header-anchor">#</a> 消息送达回执</h3> <p>若在消息送达时收到通知，你可以打开消息送达开关，这样在消息到达对方设备时你可以收到通知。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 设置是否需要接收方送达确认，默认 `false` 即不需要。</span>
options<span class="token punctuation">.</span><span class="token function">setRequireDeliveryAck</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>onMessageDelivered</code> 回调是对方收到消息时的通知，你可以在收到该通知时，显示消息的送达状态。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMMessageListener</span> msgListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EMMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        
    <span class="token comment">// 收到消息。</span>
    <span class="token annotation punctuation">@Override</span>    
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessageReceived</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token punctuation">}</span>            
    <span class="token comment">// 收到已送达回执。</span>
    <span class="token annotation punctuation">@Override</span>    
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessageDelivered</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMMessage</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 记得在不需要的时候移除 listener，如在 activity 的 onDestroy() 时。</span>
<span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeMessageListener</span><span class="token punctuation">(</span>msgListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="消息已读回执"><a href="#消息已读回执" class="header-anchor">#</a> 消息已读回执</h3> <p>消息已读回执用于告知单聊或群聊中的用户接收方已阅读其发送的消息。为降低消息已读回执方法的调用次数，SDK 还支持在单聊中使用会话已读回执功能，用于获知接收方是否阅读了会话中的未读消息。</p> <h4 id="单聊"><a href="#单聊" class="header-anchor">#</a> 单聊</h4> <p>单聊既支持消息已读回执，也支持会话已读回执。我们建议你按照如下逻辑结合使用两种回执，减少发送消息已读回执数量。</p> <ul><li>聊天页面未打开时，若有未读消息，进入聊天页面，发送会话已读回执；</li> <li>聊天页面打开时，若收到消息，发送消息已读回执。</li></ul> <p>第一步是在设置中打开已读回执开关：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 设置是否需要消息已读回执，设为 `true`。</span>
<span class="token class-name">Options</span><span class="token punctuation">.</span>setRequireAck <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="会话已读回执"><a href="#会话已读回执" class="header-anchor">#</a> 会话已读回执</h5> <p>参考以下步骤在单聊中实现会话已读回执。</p> <ol><li>接收方发送会话已读回执。</li></ol> <p>消息接收方进入会话页面，查看会话中是否有未读消息。若有，发送会话已读回执，没有则不再发送。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ackConversationRead</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HyphenateException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该方法为异步方法，需要捕捉异常。</p> <ol start="2"><li>消息发送方监听会话已读回执的回调。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addConversationListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EMConversationListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ……
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConversationRead</span><span class="token punctuation">(</span><span class="token class-name">String</span> from<span class="token punctuation">,</span> <span class="token class-name">String</span> <span class="token keyword">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 添加刷新页面通知等逻辑。</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>同一用户 ID 登录多设备的情况下，用户在一台设备上发送会话已读回执，服务器会将会话的未读消息数置为 <code>0</code>，同时其他设备会收到 <code>OnConversationRead</code> 回调。</p></blockquote> <h5 id="消息已读回执-2"><a href="#消息已读回执-2" class="header-anchor">#</a> 消息已读回执</h5> <p>参考如下步骤在单聊中实现消息已读回执。</p> <ol><li>接收方发送已读回执消息。</li></ol> <p>消息接收方进入会话时，发送会话已读回执。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>    
    <span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ackMessageRead</span><span class="token punctuation">(</span>conversationId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HyphenateException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在会话页面，接收到消息时，根据消息类型发送消息已读回执，如下所示：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EMMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessageReceived</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">sendReadAck</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">/**
    * 发送已读回执。
    * @param message
    */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendReadAck</span><span class="token punctuation">(</span><span class="token class-name">EMMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里是接收的消息，未发送过已读回执且是单聊。</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">direct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EMMessage<span class="token punctuation">.</span>Direct</span><span class="token punctuation">.</span>RECEIVE
            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>message<span class="token punctuation">.</span><span class="token function">isAcked</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> message<span class="token punctuation">.</span><span class="token function">getChatType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">EMMessage<span class="token punctuation">.</span>ChatType<span class="token punctuation">.</span>Chat</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EMMessage<span class="token punctuation">.</span>Type</span> type <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 视频，语音及文件需要点击后再发送，可以根据需求进行调整。</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token class-name">EMMessage<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span>VIDEO <span class="token operator">||</span> type <span class="token operator">==</span> <span class="token class-name">EMMessage<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span>VOICE <span class="token operator">||</span> type <span class="token operator">==</span> <span class="token class-name">EMMessage<span class="token punctuation">.</span>Type</span><span class="token punctuation">.</span>FILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ackMessageRead</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HyphenateException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
</code></pre></div><ol start="2"><li>消息发送方监听消息已读回调。</li></ol> <p>你可以调用接口监听指定消息是否已读，示例代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EMMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessageRead</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMMessage</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 添加刷新消息等逻辑。</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="群聊"><a href="#群聊" class="header-anchor">#</a> 群聊</h4> <p>对于群组消息，你可以设置消息是否需要已读回执，无法设置会话已读回执。</p> <ol><li>设置 <code>EMMessage</code> 的方法 <code>setIsNeedGroupAck()</code> 为 <code>YES</code>。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">EMMessage</span> message <span class="token operator">=</span> <span class="token class-name">EMMessage</span><span class="token punctuation">.</span><span class="token function">createTxtSendMessage</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
message<span class="token punctuation">.</span><span class="token function">setIsNeedGroupAck</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>消息接收方发送群组消息的已读回执。</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendAckMessage</span><span class="token punctuation">(</span><span class="token class-name">EMMessage</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">validateMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">isAcked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// May a user login from multiple devices, so do not need to send the ack msg.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">isNeedGroupAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>message<span class="token punctuation">.</span><span class="token function">isUnread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> <span class="token keyword">to</span> <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">conversationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do not use getFrom() here</span>
                <span class="token class-name">String</span> msgId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">EMClient</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chatManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ackGroupMessageRead</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">,</span> msgId<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">EMTextMessageBody</span><span class="token punctuation">)</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                message<span class="token punctuation">.</span><span class="token function">setUnread</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">EMLog</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">&quot;Send the group ack cmd-type message.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">EMLog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>消息发送方监听群组消息已读回调。</li></ol> <p>群消息已读回调在消息监听类 <code>EMMessageListener</code> 中。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 接收到群组消息体的已读回执, 消息的接收方已经阅读此消息。</span>
 <span class="token keyword">void</span> <span class="token function">onGroupMessageRead</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMGroupReadAck</span><span class="token punctuation">&gt;</span></span> groupReadAcks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      
 <span class="token punctuation">}</span>
</code></pre></div><p>接收到群组消息已读回执后，发出消息的属性 <code>groupAckCount</code> 会有相应变化；</p> <ol start="4"><li>消息发送方获取群组消息的已读回执详情。</li></ol> <p>如果想实现群消息已读回执的列表显示，可以通过下列接口获取到已读回执的详情。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * 从服务器获取群组消息回执详情。
     * 分页获取。
     * 发送群组消息回执，详见{@link #ackGroupMessageRead(String, String, String)}。
     *
     * 异步方法。
     *
     * @param msgId         消息 ID。
     * @param pageSize      每次获取群消息已读回执的条数。
     * @param startAckId    已读回执 ID，如果为空，从最新的回执向前开始获取。
     * @param callBack      结果回调，成功执行 {@link EMValueCallBack#onSuccess(Object)}，失败执行 {@link EMValueCallBack#onError(int, String)}。
     *
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">asyncFetchGroupReadAcks</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> msgId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span>
                                        <span class="token keyword">final</span> <span class="token class-name">String</span> startAckId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">EMValueCallBack</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EMCursorResult</span><span class="token punctuation">&lt;</span><span class="token class-name">EMGroupReadAck</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> callBack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        

    <span class="token punctuation">}</span>
</code></pre></div><h3 id="更多操作"><a href="#更多操作" class="header-anchor">#</a> 更多操作</h3> <p>你可以参考如下文档，在项目中实现更多的消息相关功能：</p> <ul><li><a href="https://docs-im.easemob.com/ccim/android/message1" target="_blank" rel="noopener noreferrer">消息概述<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>;</li> <li><a href="https://docs-im.easemob.com/ccim/android/message2" target="_blank" rel="noopener noreferrer">发送和接收消息<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li><a href="https://docs-im.easemob.com/ccim/android/message3" target="_blank" rel="noopener noreferrer">管理本地消息数据<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li><a href="https://docs-im.easemob.com/ccim/android/message4" target="_blank" rel="noopener noreferrer">从服务器获取会话和消息（消息漫游）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li><a href="https://docs-im.easemob.com/ccim/android/translation" target="_blank" rel="noopener noreferrer">实现翻译功能<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul></div> <div class="back-to-top hidden"></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/maniacflow/vuepress/edit/master/docs/document/Android/message_receipt_android.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated">更新时间：2022/7/26 下午6:26:25</div></div></div></div> <link id="code-theme" rel="stylesheet"></div><div class="global-ui"></div></div>
    <script src="/vuepress/assets/js/app.3775eb30.js" defer></script><script src="/vuepress/assets/js/3.db456b6c.js" defer></script><script src="/vuepress/assets/js/1.7ac2d96d.js" defer></script><script src="/vuepress/assets/js/20.5ef4c978.js" defer></script>
  </body>
</html>
